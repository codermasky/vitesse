services:
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "9001:8000"
    environment:
      - DATABASE_URI=postgresql://${POSTGRES_USER:-vitesse}:${POSTGRES_PASSWORD:-vitesse123}@db:5432/${POSTGRES_DB:-vitesse}
      - SECRET_KEY=${SECRET_KEY}
      - POSTGRES_SERVER=db
      - POSTGRES_USER=${POSTGRES_USER:-vitesse}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vitesse123}
      - POSTGRES_DB=${POSTGRES_DB:-vitesse}
      - QDRANT_URL=http://qdrant:6333
    depends_on:
      db:
        condition: service_healthy
      # qdrant is optional - backend will work without it
      # qdrant:
      #   condition: service_healthy
    volumes:
      - ./backend:/app
      - /Users/sujitm/Sandbox/aether:/app/aether
      - /var/run/docker.sock:/var/run/docker.sock
      - /app/.venv
    networks:
      - vitesse-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:9001/api/v1
    ports:
      - "9002:80"
    depends_on:
      - backend
    networks:
      - vitesse-network

  db:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-vitesse}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vitesse123}
      - POSTGRES_DB=${POSTGRES_DB:-vitesse}
    ports:
      - "9005:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vitesse} -d ${POSTGRES_DB:-vitesse}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - vitesse-network

  # Qdrant Vector Database - Enterprise-grade vector search
  qdrant:
    image: qdrant/qdrant:v1.8.1
    container_name: vitesse-qdrant
    ports:
      - "6333:6333"      # HTTP API
      - "6334:6334"      # gRPC API
    volumes:
      - qdrant_storage:/qdrant/storage
      - qdrant_snapshots:/qdrant/snapshots
    environment:
      # Optional: QDRANT_API_KEY for authentication
      # QDRANT_API_KEY: "your-api-key-here"
      
      # Performance tuning
      QDRANT_STORAGE__SNAPSHOTS_PATH: /qdrant/snapshots
      QDRANT_STORAGE__STORAGE_PATH: /qdrant/storage
      
      # Telemetry (disable for privacy)
      QDRANT_TELEMETRY_DISABLED: "true"
    healthcheck:
      test: ["CMD", "bash", "-c", "(echo > /dev/tcp/127.0.0.1/6333) && exit 0 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - vitesse-network
    restart: unless-stopped

volumes:
  postgres_data:
  qdrant_storage:
    driver: local
  qdrant_snapshots:
    driver: local

networks:
  vitesse-network:
    driver: bridge
